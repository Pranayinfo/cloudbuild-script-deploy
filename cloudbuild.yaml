steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'authenticate-gke'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Authenticating to GKE cluster..."
        gcloud container clusters get-credentials ${_CLUSTER} --zone ${_ZONE}

  # Step 2: SSH into the GCE VM, archive the HTML files, and copy to Cloud Build environment
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'archive-html'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Archiving HTML files from GCE VM..."
        gcloud compute ssh --zone=${_ZONE} ubuntu@${_GCE_VM} --command "tar -czf /tmp/latest_html.tar.gz -C /var/www/html ."

  # Step 3: Download the HTML archive from GCE VM to Cloud Build
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'download-html'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Downloading HTML archive from the GCE VM..."
        gcloud compute scp ubuntu@${_GCE_VM}:/tmp/latest_html.tar.gz /workspace/latest_html.tar.gz --zone=${_ZONE}

  # Step 4: Upload the HTML archive to GCS bucket
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-html'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Uploading HTML archive to GCS bucket..."
        gsutil cp /workspace/latest_html.tar.gz gs://${_BUCKET}/latest_html.tar.gz


  # Step 6: Copy the HTML archive to the GKE pod
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'copy-to-gke'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Copying HTML archive to GKE pod..."
        kubectl cp /workspace/latest_html.tar.gz ${_NAMESPACE}/${_POD_NAME}:/tmp/ -n ${_NAMESPACE}

  # Step 7: Extract HTML files inside the GKE pod
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'extract-html'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Extracting HTML files inside the GKE pod..."
        kubectl exec -n ${_NAMESPACE} ${_POD_NAME} -- bash -c "
          mkdir -p /usr/share/nginx/html &&
          tar -xzf /tmp/latest_html.tar.gz -C /usr/share/nginx/html &&
          rm /tmp/latest_html.tar.gz
        "

  # Step 8: Clean up temporary files in Cloud Build
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'cleanup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Cleaning up temporary files..."
        rm -f /workspace/latest_html.tar.gz

substitutions:
  _GCE_VM: 'jumpserver'
  _BUCKET: 'demo-bucket-sql-dump'
  _REGION: 'us-central1'
  _ZONE: 'us-central1-c'
  _CLUSTER: 'demo-cluster-1'
  _POD_NAME: 'nginx'
  _NAMESPACE: 'free'

options:
  logging: CLOUD_LOGGING_ONLY

timeout: '1200s'  # 20 minutes (adjust as needed)
