steps:
  # Step 2: SSH into the GCE VM, archive the HTML files, and copy to Cloud Build environment
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'archive-html'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Archiving HTML files from GCE VM..."
        gcloud compute ssh --zone=${_ZONE} ubuntu@${_GCE_VM} --command "tar -czf /tmp/latest_html.tar.gz -C /var/www/html ."

  # Step 3: Download the HTML archive from GCE VM to Cloud Build
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'download-html'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Downloading HTML archive from the GCE VM..."
        gcloud compute scp ubuntu@${_GCE_VM}:/tmp/latest_html.tar.gz /workspace/latest_html.tar.gz --zone=${_ZONE}

  # Step 4: Upload the HTML archive to GCS bucket
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-html'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Uploading HTML archive to GCS bucket..."
        gsutil cp /workspace/latest_html.tar.gz gs://${_BUCKET}/latest_html.tar.gz

  - name: 'google/cloud-sdk:slim'
    id: 'authenticate-gke'
    entrypoint: 'sh'
    args:
      - -c
      - |
        # Install kubectl and gke-gcloud-auth-plugin
        apt-get update && apt-get install -y kubectl google-cloud-cli-gke-gcloud-auth-plugin

        # Authenticate with GKE
        gcloud config set project ${_PROJECT_ID}
        gcloud config set compute/zone ${_ZONE}
        gcloud container clusters get-credentials ${_CLUSTER} --region ${_ZONE}
        
 # Step 6: Download HTML archive from GCS to Cloud Build environment
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'download-from-gcs'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Downloading HTML archive from GCS..."
        gsutil cp gs://${_BUCKET}/latest_html.tar.gz /workspace/latest_html.tar.gz

  # Step 7: Copy the HTML archive to the GKE pod
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'copy-to-gke'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Copying HTML archive to GKE pod..."
        kubectl get pods -n free
        kubectl cp /workspace/latest_html.tar.gz ${_NAMESPACE}/${_POD_NAME}:/tmp/ -n ${_NAMESPACE}
    args:
      - '-c'
      - |
        POD_NAME=$(kubectl get pods -n ${_NAMESPACE} -l app=nginx -o jsonpath='{.items[0].metadata.name}')
        kubectl cp /workspace/latest_html.tar.gz ${_NAMESPACE}/${POD_NAME}:/tmp/ -n ${_NAMESPACE}


  # Step 7: Extract HTML files inside the GKE pod
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'extract-html'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Extracting HTML files inside the GKE pod..."
        kubectl exec -n ${_NAMESPACE} ${_POD_NAME} -- bash -c "
          mkdir -p /usr/share/nginx/html &&
          tar -xzf /tmp/latest_html.tar.gz -C /usr/share/nginx/html &&
          rm /tmp/latest_html.tar.gz
        "

  # Step 8: Clean up temporary files in Cloud Build
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'cleanup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Cleaning up temporary files..."
        rm -f /workspace/latest_html.tar.gz

substitutions:
  _GCE_VM: 'jumpserver'
  _PROJECT_ID: 'feisty-return-438307-f5'
  _BUCKET: 'demo-bucket-sql-dump'
  _REGION: 'us-central1'
  _ZONE: 'us-central1-c'
  _CLUSTER: 'demo-cluster-1'
  #_POD_NAME: 'nginx'
  _NAMESPACE: 'free'

options:
  logging: CLOUD_LOGGING_ONLY

timeout: '1200s'  # 20 minutes (adjust as needed)
